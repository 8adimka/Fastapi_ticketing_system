# Catalog service

## Содержание

1. [Описание проекта](#описание)
2. [Используемые технологии](#используемые-технологии)
3. [Структура проекта](#структура-проекта)
4. [Работа с проектом](#работа-с-проектом)  
4.1 [Настройка виртуального окружения](#настройка-виртуального-окружения)
4.2 [Переменные окружения](#переменные-окружения)  
4.3 [Управление миграциями через Alembic](#управление-миграциями-через-Alembic)  
4.4 [Запуск проекта](#запуск-проекта)  
    * [Этапы запуска](#этапы-запуска)  
5. [Полезные материалы](#полезные-материалы)

## Описание

### Тикет-система

Тикет-система должна состоять из:  

* Тикетов, у тикетов могут быть комментарии
* Тикет создается в статусе “открыт”, может перейти в “отвечен” или “закрыт”, из  
отвечен в “ожидает ответа” или “закрыт”, статус “закрыт” финальный (нельзя  
изменить статус или добавить комментарий)  

## Используемые технологии

* Код приложения пишется на **Python + FastAPI**.
* Приложение запускается под управлением сервера **ASGI**(uvicorn).
* Хранилище – **PostgreSQL**.
* За кеширование данных отвечает – **redis cluster**.

## Структура проекта

* Корень проекта — в нём находятся базовые вещи, например, ci и gitignore.
* `src` — содержит исходный код приложения.
* `main.py` — входная точка приложения.
* `api` — модуль, в котором реализуется API. Другими словами,
  это модуль для предоставления http-интерфейса клиентским приложениям.
  Внутри модуля отсутствует какая-либо бизнес-логика, так как она не должна быть завязана на HTTP.
* `core` — содержит разные конфигурационные файлы.
* `db` — предоставляет объекты баз данных (Redis, PostgreSQL) и провайдеры для внедрения зависимостей.
  Redis будет использоваться для кеширования, чтобы не нагружать лишний раз PostgreSQL.
* `models` — содержит классы, описывающие бизнес-сущности
* `schemas` - содержит модели отвечающие за валидацию тела запроса.
* `services` — главное в сервисе. В этом модуле находится реализация всей бизнес-логики.
  Таким образом она отделена от транспорта. Благодаря такому разделению,  будет легче добавлять новые типы транспортов в сервис.

## Работа с проектом

### Настройка виртуального окружения

Проект использует Poetry для управления зависимостями. Установите Poetry если еще не установлен:

```bash
curl -sSL https://install.python-poetry.org | python3 -
```

Или через pip:

```bash
pip install poetry
```

Установите зависимости:

```bash
poetry install
```

Активируйте виртуальное окружение:

```bash
poetry shell
```

### Переменные окружения

```dotenv
DATABASE_DSN='<строка подключения к Database>'
REDIS_HOST='<адрес Redis хоста>'
REDIS_PORT='<порт для подключения к Redis>'
```

### Управление миграциями через Alembic

**Данные операции необходимо выполнять из директории `src`**

1. Создание миграций (используя Poetry):

   ```bash
   poetry run alembic -c ./models/alembic.ini revision -m "some message" --autogenerate
   ```

   Данная команда сгенерирует новую миграцию, но не применит её к БД.

2. Применение миграции к БД:

   ```bash
   poetry run alembic -c ./models/alembic.ini upgrade head
   ```

### Запуск проекта

Проект полностью контейнеризован и запускается одной командой:

```bash
docker-compose up --build
```

Эта команда:

1. Соберет Docker-образ приложения
2. Запустит PostgreSQL, Redis и само приложение
3. Healthchecks обеспечат правильный порядок запуска
4. Приложение автоматически применит миграции и запустится

После запуска приложение будет доступно по адресу: <http://localhost:8000>

Документация API:

* Swagger UI: <http://localhost:8000/api/openapi>
* ReDoc: <http://localhost:8000/api/redoc>

#### Переменные окружения

Создайте файл `.env` на основе `.env.example`:

```bash
cp .env.example .env
```

Отредактируйте `.env` файл при необходимости.

## Полезные материалы

[Пишем и тестируем миграции БД с Alembic](https://habr.com/ru/company/yandex/blog/511892/)  
[Poetry: документация](https://python-poetry.org/docs/)
